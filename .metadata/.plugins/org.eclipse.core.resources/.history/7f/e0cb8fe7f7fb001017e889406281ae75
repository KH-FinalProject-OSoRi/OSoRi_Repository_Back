<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="groupBudgetMapper">
 	<select id="groupBudgetList" resultType="GroupBudget" parameterType="int">
 		SELECT GROUPB_ID,TITLE,B_AMOUNT,START_DATE,END_DATE
		FROM GROUPBUDGET B JOIN BUDGETMEM M USING(GROUPB_ID)
		WHERE USER_ID = #{userId}
		AND END_DATE &gt;= SYSDATE
		AND B.STATUS = 'Y'
		AND M.STATUS = 'ACCEPTED'
		ORDER BY CREATED_AT
 	</select>
 	
 	<insert id="addNewGroupB" parameterType="GroupBudget">
	    <selectKey keyProperty="groupbId" resultType="int" order="BEFORE">
	        SELECT SEQ_GBNO.NEXTVAL FROM DUAL
	    </selectKey>
	 		INSERT INTO GROUPBUDGET (
	        GROUPB_ID,
	        TITLE,
	        B_AMOUNT,
	        START_DATE,
	        END_DATE,
	        CREATED_AT,
	        STATUS
		    )
		    VALUES (
		        #{groupbId},
		        #{title},
		        #{bAmount},
		        #{startDate},
		        #{endDate},
		        SYSDATE,
		        'Y'
		    )
	</insert>
 	
 	<insert id="addGroupAdmin" parameterType="BudgetMem">
 		INSERT INTO BUDGETMEM
 		VALUES(
 			#{groupbId},
 			#{userId},
 			#{role},
 			'ACCEPTED'
 		)
 	</insert>
 	
 	<select id="searchGroupMemberList" parameterType="String" resultType="User">
 		SELECT USER_ID,LOGIN_ID,EMAIL
		FROM USERS
		WHERE EMAIL LIKE '%'||#{keyword}||'%'
 	</select>
 	
 	<insert id="addGroupMember" parameterType="BudgetMem">
 		INSERT INTO BUDGETMEM (GROUPB_ID, USER_ID, ROLE, STATUS)
	    SELECT #{groupbId}, #{userId}, #{role}, 'PENDING'
	    FROM DUAL
	    WHERE NOT EXISTS (
	        SELECT 1 
	        FROM BUDGETMEM 
	        WHERE GROUPB_ID = #{groupbId} 
	        AND USER_ID = #{userId}
	    )
 	</insert>
 	
 	<update id="deleteGroupBudget" parameterType="int">
 		UPDATE GROUPBUDGET
 		SET STATUS = 'N'
 		WHERE GROUPB_ID = #{groupbId}
 	</update>
 	
 	<update id="updateBAmount" parameterType="GroupBudget">
 		UPDATE GROUPBUDGET
 		SET B_AMOUNT = #{bAmount}
 		WHERE GROUPB_ID = #{groupbId}
 	</update>
 	
 	<select id="getAdminId" parameterType="int" resultType="String">
 		SELECT LOGIN_ID
 		FROM USERS
 		WHERE USER_ID = (SELECT USER_ID
 						 FROM BUDGETMEM
 						 WHERE ROLE = 'ADMIN'
 						 AND GROUPB_ID = #{groupbId})
 	</select>
 	
 	<select id="getLoginid" parameterType="int" resultType="String">
 		SELECT LOGIN_ID
 		FROM USERS
 		WHERE USER_ID = #{userId}
 	</select>
 	
 	<update id="updateInviStatus" parameterType="BudgetMem">
 		UPDATE BUDGETMEM
 		SET STATUS = #{status}
 		WHERE USER_ID = #{userId}
 		AND GROUPB_ID = #{groupbId}
 	</update>
 	
 	<update id="updateIsRead" parameterType="int">
 		UPDATE NOTIFICATION
 		SET IS_READ ='Y'
 		WHERE NOTI_ID = #{notiId}
 	</update>
 	
 	<select id="notiList" parameterType="String" resultType="Notification">
 		SELECT NOTI_ID, MESSAGE, 
 		WHERE IS_READ = 'N'
 		AND RECEIVER = #{loginId}
 	</select>
 	
 	
 	
 </mapper>